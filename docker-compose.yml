services:
  # 1. MySQL (DB)
  db:
    image: mysql:8.0
    container_name: my-db
    restart: always
    env_file:
      - .env
    ports:
      - "3307:3306"
    volumes:
      - db_data:/var/lib/mysql
    # â–¼â–¼â–¼ [ì¶”ê°€] DBê°€ ì§„ì§œ ì¤€ë¹„ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í—¬ìŠ¤ì²´í¬ â–¼â–¼â–¼
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Redis
  redis:
    image: redis:alpine
    container_name: my-redis
    ports:
      - "6379:6379"

# 3. Backend (FastAPI)
  backend:
    build: ./backend
    container_name: my-backend
    # â–¼â–¼â–¼ [í•µì‹¬ ìˆ˜ì •] ì‹œì‘í•  ë•Œ DBë¥¼ ë¬´ì¡°ê±´ ì´ˆê¸°í™”í•˜ëŠ” ì½”ë“œ ì¶”ê°€ â–¼â–¼â–¼
    command: >
      sh -c "
      echo 'Waiting for DB...' &&
      python -c \"import time; time.sleep(5)\" &&
      
      echo 'ğŸ”¥ FORCE DROPPING ALL TABLES...' &&
      python -c 'import os; from sqlalchemy import create_engine, MetaData; engine = create_engine(os.environ.get("DATABASE_URL")); meta = MetaData(); meta.reflect(bind=engine); meta.drop_all(bind=engine)' &&
      
      echo 'ğŸš€ Running Migrations...' &&
      alembic upgrade head &&
      
      echo 'ğŸŒ± Seeding Data...' &&
      python AI_generated_seed_avatar_metas.py &&
      
      echo 'âš™ï¸ Init DB...' &&
      python init_db_force.py &&
      
      echo 'âœ… Starting Server...' &&
      uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
      
    env_file:
      - .env
    volumes:
      - ./backend:/app
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    # â–¼â–¼â–¼ [ìˆ˜ì •] ë¬´í•œ ì¬ì‹œì‘ ë°©ì§€ (ì—ëŸ¬ ë¡œê·¸ í™•ì¸ìš©) â–¼â–¼â–¼
    restart: "no"

  # 4. Celery Worker
  celery_worker:
    build: ./backend
    container_name: my-celery
    command: celery -A app.worker.celery_app worker --loglevel=info
    env_file:
      - .env
    volumes:
      - ./backend:/app
    depends_on:
      - backend
      - redis

  # 5. Frontend
  frontend:
    build: ./frontend
    container_name: my-frontend
    command: npm run dev -- --host
    env_file:
      - .env
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    stdin_open: true
    tty: true

volumes:
  db_data: