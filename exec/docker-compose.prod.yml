services:
  # 1. MySQL (DB) - Internal Only + Localhost Access
  db:
    image: mysql:8.0
    container_name: my-db-prod
    # ë¡œì»¬(EC2 ë‚´ë¶€)ì—ì„œë§Œ ì ‘ì† ê°€ëŠ¥í•˜ë„ë¡ 127.0.0.1 ë°”ì¸ë”© (VS Code ì ‘ì†ìš©)
    ports:
      - "127.0.0.1:3306:3306"
    restart: always
    env_file:
      - .env.prod
    volumes:
      - db_data_prod:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Redis - Internal Only
  redis:
    image: redis:alpine
    container_name: my-redis-prod
    restart: always

  # 3. Backend (FastAPI)
  backend:
    build: ./backend
    container_name: my-backend-prod
    restart: always
    # â–¼â–¼â–¼ [ë³‘í•© ì™„ë£Œ] ë°ì´í„° ì‚­ì œ(Drop)ëŠ” ë¹¼ê³ , ë¶€ì¡±í•œ ë°ì´í„° ì±„ìš°ê¸°(Seed)ë§Œ ì¶”ê°€í•¨ â–¼â–¼â–¼
    command: >
      sh -c " echo 'â³ Waiting for DB...' && python -c \"import time; time.sleep(5)\" &&

      echo 'ğŸš€ Running Migrations...' && alembic upgrade head &&

      echo 'ğŸ‘¾ Seeding Avatar Data (If missing)...' && python AI_generated_seed_avatar_metas.py &&

      echo 'ğŸ“œ Seeding Quest Data (If missing)...' && python init_db_force.py &&

      echo 'âœ… Starting Server...' && uvicorn app.main:app --host 0.0.0.0 --port 8000"
    env_file:
      - .env.prod
    volumes:
      - ./backend:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started

  # 4. Celery Worker
  celery_worker:
    build: ./backend
    container_name: my-celery-prod
    restart: always
    command: celery -A app.worker.celery_app worker --loglevel=info
    env_file:
      - .env.prod
    volumes:
      - ./backend:/app
    depends_on:
      - backend
      - redis

  # 5. Frontend Build (Static Asset Generation)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      # â–¼â–¼â–¼ HTTPS ì£¼ì†Œ í•˜ë“œì½”ë”© (Mixed Content ë°©ì§€) â–¼â–¼â–¼
      args:
        - VITE_API_URL=https://eggit.example.com/api/v1
        - VITE_REDIRECT_URI=https://eggit.example.com/auth/callback
        - VITE_GITHUB_CLIENT_ID=Ov23lisGN4XypRG73QOl
    container_name: my-frontend-build-prod
    volumes:
      - frontend_dist:/dist

  # 6. Nginx Reverse Proxy & Static File Server
  nginx:
    image: nginx:alpine
    container_name: my-nginx-prod
    restart: always
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - frontend_dist:/usr/share/nginx/html:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      # ë¹Œë“œê°€ ì™„ë£Œëœ í›„ Nginxê°€ ì¼œì§€ë„ë¡ ì¡°ê±´ ì¶”ê°€ (ê¶Œì¥)
      frontend:
        condition: service_completed_successfully
      backend:
        condition: service_started

volumes:
  db_data_prod:
  frontend_dist:
